"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function matchClass(e,t){if(!(e&&e.length&&t&&t.length))return!1;if(1==e.length&&1==t.length)return e[0]==t[0];if(e.length<t.length)return!1;for(var n=t;n--;){for(var r=!1,s=e.length;s--;)e[s]==t[n]&&(r=!0);if(!r)return!1}return!0}function matchStyle(e,t,n,r){if("*"==r)return 0;var s=r.match(/^[^.#\s]+/),i=r.match(/\.[^.#\s]+/g),a=r.match(/#[^.#\s]+/);return a?n==a?i&&!matchClass(t,i)||s&&e!=s[0]?-1:2:-1:i?matchClass(t,i)?s&&e!=s[0]?-1:1:-1:s&&e==s[0]?0:-1}function parseCss(e,t,n){function r(){for(var t=1,n=i+1;n<e.length;n++)if("{"==e[n])t++;else if("}"==e[n]&&0==--t)break;a=n+1}var s,i,a=0;for(e=e.replace(/\/\*[\s\S]*?\*\//g,"");a<e.length&&-1!=(i=e.indexOf("{",a));){var l=e.substring(a,i);if("@"!=l[0])if(l=l.trim(),"}"==l[0]&&(l=l.substring(1)),"."==l[0]||"#"==l[0]||"["==l[0]||"*"==l[0]||l>="a"&&l<="z"||l>="A"&&l<="Z"){var u=l.split(",");if(a=i+1,-1==(i=e.indexOf("}",a)))break;var c=e.substring(a,i);a=i+1;for(var o=0;o<u.length;o++){var f={key:u[o].trim(),content:c};if(!f.key.includes(":")||(s=f.key.split(":"),f.key=s[0].trim(),f.pseudo=s.pop(),"before"==f.pseudo||"after"==f.pseudo)){if(f.key.includes("[")&&(f.attr=[],f.key=f.key.replace(/\[(.+?)\]/g,function(e,t){if(t.includes("=")){s=t.split("=");var n=s[1].trim();('"'==n[0]&&'"'==n[n.length-1]||"'"==n[0]&&"'"==n[n.length-1])&&(n=n.substring(1,n.length-1)),f.attr.push({name:s[0].trim(),value:n})}else f.attr.push({name:t.trim()});return""}).trim(),f.key||(f.key="*")),f.key.includes(" ")||f.key.includes(">")){var h=f.key.replace(/\s*>\s*/g," >").split(/\s+/);f.list=h,f.key=h[0],f.index=0}t.push(f)}}}else r();else if("@media"==l.substring(0,6)){if((s=l.match(/\((.+?):(.+?)\)/))&&s[2].includes("px")){var d=parseInt(s[2]);if("min-width"==s[1]&&n>d||"max-width"==s[1]&&n<d){a=i+1;continue}r()}}else r()}}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),cfg=require("./config.js"),CssHandler=function(){function e(){var t=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments[1];_classCallCheck(this,e),this.getStyle=function(e){return parseCss(e,t.styles,t.screenWidth)},this.screenWidth=r,this.styles=[];var s=Object.assign({},cfg.userAgentStyles);for(var i in n)s[i]=(s[i]?s[i]+";":"")+n[i];for(var a in s)this.styles.push({key:a,content:s[a]})}return _createClass(e,[{key:"match",value:function(e,t,n){var r=[];if(t.class)for(var s=t.class.split(/\s+/),i=s.length;i--;)r.unshift("."+s[i]);var a,l="",u="",c="",o=!1;n.i=[],n.index=[],n.pseudo=[];for(var f,h=0;f=this.styles[h];h++){">"==f.key[0]?(a=f.key.substring(1),o=!0):(a=f.key,o=!1);var d=matchStyle(e,r,t.id?"#"+t.id:"",a);if(-1!=d)if(Object.hasOwnProperty.call(f,"index")&&f.index!=f.list.length-1)n.i.push(h),n.index.push(f.index),f.index++,f.key=f.list[f.index];else{var p=!0;if(f.attr)for(var v=0;v<f.attr.length;v++)Object.hasOwnProperty.call(f.attr[v],"value")?t[f.attr[v].name]!=f.attr[v].value&&(p=!1):Object.hasOwnProperty.call(t,f.attr[v].name)||(p=!1);p&&(f.pseudo?n.pseudo.push(f):0==d?l+=";"+f.content:1==d?u+=";"+f.content:c+=";"+f.content)}o&&(n.i.push(h),n.index.push(f.index),f.index--,f.key=f.list[f.index])}return n.i.length||(n.i=void 0,n.index=void 0),n.pseudo.length||(n.pseudo=void 0),l+";"+u+";"+c+";"}},{key:"pop",value:function(e){if(e.i){for(var t=0;t<e.i.length;t++){var n=e.i[t];this.styles[n].key=this.styles[n].list[e.index[t]],this.styles[n].index=e.index[t]}e.i=void 0,e.index=void 0}if(e.pseudo)for(var r=0;r<e.pseudo.length;r++){var s,i=e.pseudo[r].content.replace(/content:([^;\n]*)/,function(t,n){return s=n.replace(/attr\((.+?)\)/,function(t,n){return e.attrs[n.trim()]||""}).replace(/\s*['"](.*?)['"]\s*/g,"$1").replace(/\\(\w{4})/,function(e,t){return String.fromCharCode(parseInt(t,16))}),""}),a={name:"span",attrs:{style:i},children:[{type:"text",text:s}]};"before"==e.pseudo[r].pseudo?e.children.unshift(a):e.children.push(a)}}}]),e}();module.exports=CssHandler;